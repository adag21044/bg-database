using UnityEngine;
using BansheeGz.BGDatabase;
using System;
using System.Collections.Generic;
using TMPro;

/// <summary>
/// üß© Hyper-casual meta debugger (BGDatabase Integrated)
/// - Works with BGDatabase 1.2.x‚Äì1.3.x
/// - Reads typed parameters (int, float, bool, string)
/// - Connects GameObjects to DB rows dynamically
/// - Demonstrates auto-binding via BGEntityGo and BGDataBinderFieldGo
/// </summary>
[DisallowMultipleComponent]
public class Debugger : MonoBehaviour
{
    // üîß BGDatabase Components (Auto-Detected)
    private BGDatabasePreloaderGo preloader;
    private BGDataBinderDatabaseGo dbBinder;
    private BGDataBinderBatchGo batchBinder;
    private BGDataBinderFieldGo fieldBinder;
    private BGDataBinderRowGo rowBinder;
    private BGDataBinderGraphGo graphBinder;
    private BGDataBinderTemplateGo templateBinder;
    private BGEntityGo entityGo;

    // üîó Example GameObjects for DB connections
    [Header("DB Connection Targets")]
    public GameObject playerObject;
    public GameObject machineObject;
    public GameObject uiCoinText;

    void Awake()
    {
        // Auto-discover BG components on this GameObject
        preloader = GetComponent<BGDatabasePreloaderGo>();
        dbBinder = GetComponent<BGDataBinderDatabaseGo>();
        batchBinder = GetComponent<BGDataBinderBatchGo>();
        fieldBinder = GetComponent<BGDataBinderFieldGo>();
        rowBinder = GetComponent<BGDataBinderRowGo>();
        graphBinder = GetComponent<BGDataBinderGraphGo>();
        templateBinder = GetComponent<BGDataBinderTemplateGo>();
        entityGo = GetComponent<BGEntityGo>();

        var tmp = uiCoinText.GetComponent<TextMeshPro>();
        if (tmp == null)
        {
            Debug.LogWarning("‚ö†Ô∏è UI object does not have TextMeshProUGUI component!");
            return;
        }
    }

    void Start()
    {
        DebugListFields(BGRepo.I["Items"]);
        Debug.Log("=== üß© HyperCasual Meta Debugger Started (Full Integration) ===");

        if (BGRepo.I == null)
        {
            Debug.LogError("‚ùå BGDatabase repository not found! Add the prefab to the scene.");
            return;
        }

        // 1Ô∏è‚É£ Safe table loading
        var items = SafeGetTable("Items");
        var machines = SafeGetTable("Machines");
        var playerStats = SafeGetTable("PlayerStats");
        var upgrades = SafeGetTable("Upgrades");
        var gameParams = SafeGetTable("GameParams");

        // 2Ô∏è‚É£ Load typed parameters
        var paramDict = LoadParameters(gameParams);

        // 3Ô∏è‚É£ Simulations
        if (items != null) Test_Items(items);
        if (playerStats != null) Simulate_PlayerProgress(playerStats, paramDict);
        if (machines != null && upgrades != null) Simulate_MachineProduction(machines, upgrades, paramDict);

        // 4Ô∏è‚É£ Connect GameObjects to DB rows
        ConnectGameObjectsToDatabase(playerStats, machines);

        

        // 5Ô∏è‚É£ Auto-bind UI fields (e.g., coins)
        BindUIFieldToDatabase(playerStats, "Coins");

        // 6Ô∏è‚É£ Test all detected binders
        TestAllBinders_Legacy();

        // 7Ô∏è‚É£ Save database
        BGRepo.I.Save();
        Debug.Log("üíæ Repository saved successfully.");
        Debug.Log("‚úÖ Simulation finished.");
    }

    // ======================================================
    // üîó Connect GameObjects to DB Rows (BGEntityGo)
    // ======================================================
    private void ConnectGameObjectsToDatabase(BGMetaEntity playerStats, BGMetaEntity machines)
    {
        Debug.Log("=== üîó Connecting GameObjects to Database Rows ===");

        if (playerObject != null && playerStats != null)
        {
            var entityGo = playerObject.AddComponent<BGEntityGo>();
            entityGo.Entity = playerStats.GetEntity(0);
            Debug.Log($"üéÆ Linked {playerObject.name} ‚Üí PlayerStats[0]");
        }

        if (machineObject != null && machines != null)
        {
            var entityGo = machineObject.AddComponent<BGEntityGo>();
            entityGo.Entity = machines.GetEntity(0);
            Debug.Log($"üè≠ Linked {machineObject.name} ‚Üí Machines[0]");
        }
    }

    // ======================================================
    // üéØ Bind a specific field to a UI GameObject (LEGACY SAFE)
    // ======================================================
    private void BindUIFieldToDatabase(BGMetaEntity playerStats, string fieldName)
    {
        if (uiCoinText == null || playerStats == null)
        {
            Debug.LogWarning("‚ö†Ô∏è UI or PlayerStats not assigned.");
            return;
        }

        var entity = playerStats.GetEntity(0);
        if (entity == null)
        {
            Debug.LogWarning("‚ö†Ô∏è No entity found in PlayerStats table!");
            return;
        }

        // üîç Field adƒ±nƒ± normalize et (case-insensitive kar≈üƒ±la≈ütƒ±rma)
        string matchedField = null;
        for (int i = 0; i < playerStats.CountFields; i++)
        {
            var field = playerStats.GetField(i);
            if (string.Equals(field.Name.Trim(), fieldName.Trim(), StringComparison.OrdinalIgnoreCase))
            {
                matchedField = field.Name;
                break;
            }
        }

        if (matchedField == null)
        {
            Debug.LogWarning($"‚ö†Ô∏è Field '{fieldName}' not found in PlayerStats!");
            return;
        }

        // üß† Deƒüeri al
        object value = "N/A";
        
        try
        {
            // En sƒ±k kullanƒ±lan tipleri sƒ±rayla dene
            try { value = entity.Get<int>(matchedField); }
            catch
            {
                try { value = entity.Get<float>(matchedField); }
                catch
                {
                    try { value = entity.Get<string>(matchedField); }
                    catch
                    {
                        try { value = entity.Get<bool>(matchedField); }
                        catch
                        {
                            value = "(unknown type)";
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Debug.LogWarning($"‚ö†Ô∏è Could not read value for '{matchedField}': {ex.Message}");
            value = "(error)";
        }

        // üí¨ UI Text g√ºncelle
        var tmp = uiCoinText.GetComponent<TextMeshProUGUI>();
        if (tmp == null)
        {
            Debug.LogError($"‚ùå {uiCoinText.name} has no TextMeshProUGUI component!");
            return;
        }
        tmp.text = $"{matchedField}: {value}";
        Debug.Log($"üí¨ Bound UI '{uiCoinText.name}' ‚Üí PlayerStats[{matchedField}] = {value}");
    }




    // ======================================================
    // ‚úÖ Safe table getter
    // ======================================================
    private BGMetaEntity SafeGetTable(string name)
    {
        var table = BGRepo.I[name];
        if (table == null)
        {
            Debug.LogWarning($"‚ö†Ô∏è Table '{name}' not found. Skipping...");
            return null;
        }
        return table;
    }

    // ======================================================
    // ‚öôÔ∏è Load typed parameters into dictionary
    // ======================================================
    private Dictionary<string, object> LoadParameters(BGMetaEntity meta)
    {
        var dict = new Dictionary<string, object>();
        if (meta == null || meta.CountEntities == 0)
        {
            Debug.LogWarning("‚ö†Ô∏è No GameParams found.");
            return dict;
        }

        Debug.Log("=== üßÆ Loading GameParams (Typed) ===");
        for (int i = 0; i < meta.CountEntities; i++)
        {
            var e = meta.GetEntity(i);
            string key = e.Get<string>("Key");
            string value = e.Get<string>("Value");
            string type = e.Get<string>("Type").ToLower();

            object parsed = value;
            try
            {
                switch (type)
                {
                    case "int": parsed = int.Parse(value); break;
                    case "float": parsed = float.Parse(value); break;
                    case "bool": parsed = bool.Parse(value); break;
                    default: parsed = value; break;
                }
            }
            catch (Exception)
            {
                Debug.LogWarning($"‚ö†Ô∏è Could not parse parameter '{key}' as {type}, keeping as string.");
            }

            dict[key] = parsed;
            Debug.Log($"üß© Param Loaded ‚Üí {key} = {parsed} ({type})");
        }

        return dict;
    }

    // ======================================================
    // üß± ITEMS TEST
    // ======================================================
    private void Test_Items(BGMetaEntity meta)
    {
        Debug.Log($"=== üì¶ Testing 'Items' Table ({meta.CountEntities} rows) ===");

        for (int i = 0; i < meta.CountEntities; i++)
        {
            var entity = meta.GetEntity(i);
            string name = entity.Get<string>("name");
            int value = entity.Get<int>("value");

            int newValue = value + UnityEngine.Random.Range(1, 5);
            entity.Set("value", newValue);

            Debug.Log($"üß± Item '{name}' updated ‚Üí {value} ‚ûú {newValue}");
        }
    }

    // ======================================================
    // ü™ô PLAYER PROGRESSION
    // ======================================================
    private void Simulate_PlayerProgress(BGMetaEntity playerStats, Dictionary<string, object> paramDict)
    {
        Debug.Log("=== üéÆ Simulating Player Progression ===");

        var player = playerStats.GetEntity(0);
        int coins = player.Get<int>("Coins");
        int xp = player.Get<int>("XP");
        int level = player.Get<int>("Level");

        int xpRequired = paramDict.ContainsKey("XPForNextLevel") ? Convert.ToInt32(paramDict["XPForNextLevel"]) : 100;
        float coinMultiplier = paramDict.ContainsKey("CoinMultiplier") ? Convert.ToSingle(paramDict["CoinMultiplier"]) : 1f;

        xp += UnityEngine.Random.Range(10, 30);
        coins += Mathf.RoundToInt(UnityEngine.Random.Range(5, 15) * coinMultiplier);

        if (xp >= xpRequired)
        {
            xp = 0;
            level++;
            Debug.Log($"‚¨ÜÔ∏è Player leveled up! Now Level {level}");
        }

        player.Set("XP", xp);
        player.Set("Coins", coins);
        player.Set("Level", level);

        Debug.Log($"üéÆ Player Progress ‚Üí Level={level}, XP={xp}/{xpRequired}, Coins={coins} (x{coinMultiplier})");
    }

    // ======================================================
    // ‚öôÔ∏è MACHINE PRODUCTION
    // ======================================================
    private void Simulate_MachineProduction(BGMetaEntity machines, BGMetaEntity upgrades, Dictionary<string, object> paramDict)
    {
        Debug.Log("=== üè≠ Simulating Machine Output ===");

        float outputMultiplier = paramDict.ContainsKey("OutputMultiplier") ? Convert.ToSingle(paramDict["OutputMultiplier"]) : 1f;

        for (int i = 0; i < machines.CountEntities; i++)
        {
            var machine = machines.GetEntity(i);
            string name = machine.Get<string>("name");
            int baseOutput = machine.Get<int>("BaseOutput");
            int level = machine.Get<int>("Level");

            int totalBonus = 0;
            for (int j = 0; j < upgrades.CountEntities; j++)
            {
                var upgrade = upgrades.GetEntity(j);
                if (upgrade.Get<string>("TargetMachine") == name)
                    totalBonus += upgrade.Get<int>("bonus");
            }

            float finalOutput = (baseOutput + totalBonus + (level * 2)) * outputMultiplier;
            Debug.Log($"üè≠ Machine '{name}' ‚Üí Output={finalOutput:F1} (Base={baseOutput}, Level={level}, Bonus={totalBonus}, x{outputMultiplier})");
        }
    }

    // ======================================================
    // üîó AUTO BINDER TESTS (LEGACY SAFE)
    // ======================================================
    private void TestAllBinders_Legacy()
    {
        Debug.Log("=== üîó Testing BGDatabase Components (Legacy Safe) ===");

        if (dbBinder != null)
            Debug.Log("üß© DB Binder found and linked to Database prefab.");

        if (batchBinder != null)
            Debug.Log("üì¶ Batch Binder found ‚Äî will bind multiple rows automatically.");

        if (fieldBinder != null)
            Debug.Log("üéØ Field Binder found ‚Äî single field binding ready.");

        if (rowBinder != null)
            Debug.Log("üß± Row Binder found ‚Äî binds one entity to GameObject.");

        if (graphBinder != null)
            Debug.Log("üîó Graph Binder found ‚Äî relational tracking available.");

        if (templateBinder != null)
            Debug.Log("üß© Template Binder found ‚Äî prefab instantiation enabled.");

        if (entityGo != null)
            Debug.Log("üéÆ EntityGo found ‚Äî represents one database entity in scene.");
    }

    private void DebugListFields(BGMetaEntity table)
    {
        if (table == null)
        {
            Debug.LogWarning("‚ö†Ô∏è Table is null!");
            return;
        }

        Debug.Log($"=== üß© Listing fields for table: {table.Name} ===");

        try
        {
            int fieldCount = table.CountFields;
            for (int i = 0; i < fieldCount; i++)
            {
                var field = table.GetField(i);
                string fieldName = field.Name;

                // üéØ Tipi runtime‚Äôdan tahmin et (tablodaki ilk entity‚Äôden oku)
                string fieldType = "Unknown";
                if (table.CountEntities > 0)
                {
                    try
                    {
                        var entity = table.GetEntity(0);
                        var value = entity.Get<object>(fieldName);
                        fieldType = value != null ? value.GetType().Name : "null";
                    }
                    catch { /* ignore */ }
                }

                Debug.Log($"üß† Field[{i}] ‚Üí {fieldName} (RuntimeType={fieldType})");
            }
        }
        catch (Exception ex)
        {
            Debug.LogError($"‚ùå Could not read fields: {ex.Message}");
        }
    }



}
